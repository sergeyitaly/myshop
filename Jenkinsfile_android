pipeline {
    agent any

    environment {
        DOCKER_IMAGE_ANDROID = 'sergeyitaly/android-builder'
        TAG = 'latest'
        PLAY_STORE_JSON_KEY = credentials('play-store-json-key')
        PATH = "/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:${env.PATH}"
    }

    stages {
        stage('Checkout Code') {
            steps {
                script {
                    echo "Checking out the repository..."
                    git branch: 'main', credentialsId: 'github-credentials-id', url: 'https://github.com/sergeyitaly/myshop.git'
                    sh "ls -lat"
                }
            }
        }

        stage('Build Android Docker Image') {
            steps {
                script {
                    echo "Building Docker image for Android..."
                    dockerImageAndroid = docker.build("${DOCKER_IMAGE_ANDROID}:${TAG}", "-f Dockerfile_android .")
                    echo "Docker image built: ${DOCKER_IMAGE_ANDROID}:${TAG}"
                }
            }
        }

        stage('Generate APK') {
            steps {
                script {
                    echo "Generating APK using Docker image..."
                    dockerImageAndroid.inside {
                        sh "fastlane android build"
                        echo "APK successfully generated!"
                    }
                }
            }
        }

        stage('Validate Google Play Key') {
            steps {
                script {
                    echo "Validating Google Play Store JSON Key..."
                    dockerImageAndroid.inside {
                        sh "fastlane supply init --json_key ${PLAY_STORE_JSON_KEY}"
                        echo "Validation successful!"
                    }
                }
            }
        }

        stage('Deploy to Google Play') {
            steps {
                script {
                    echo "Deploying APK to Google Play Store..."
                    dockerImageAndroid.inside {
                        sh "fastlane supply --apk app/build/outputs/apk/release/app-release.apk --track production --json_key ${PLAY_STORE_JSON_KEY}"
                        echo "Deployment to Play Store successful!"
                    }
                }
            }
        }
    }
}
